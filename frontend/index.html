<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart PPE Compliance Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e9ecef;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .compliance-card {
            border-left: 4px solid #28a745;
        }
        .non-compliance-card {
            border-left: 4px solid #dc3545;
        }
        .ppe-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .ppe-item i {
            margin-right: 10px;
            width: 20px;
        }
        .ppe-item.compliant i {
            color: #28a745;
        }
        .ppe-item.non-compliant i {
            color: #dc3545;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card .card-body {
            padding: 1.5rem;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hard-hat me-2"></i>
                Smart PPE Compliance Checker
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#upload">Upload</a>
                <a class="nav-link" href="camera.html">Live Camera</a>
                <a class="nav-link" href="#dashboard">Dashboard</a>
                <a class="nav-link" href="#history">History</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Upload Section -->
        <div id="upload" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-camera me-2"></i>
                    PPE Compliance Check
                </h2>
                <a href="camera.html" class="btn btn-success">
                    <i class="fas fa-video me-2"></i>
                    Live Camera Detection
                </a>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Upload Worker Photo</h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm">
                                <div class="mb-3">
                                    <label for="workerId" class="form-label">Worker ID *</label>
                                    <input type="text" class="form-control" id="workerId" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="workerName" class="form-label">Worker Name</label>
                                    <input type="text" class="form-control" id="workerName">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="department" class="form-label">Department</label>
                                            <select class="form-select" id="department">
                                                <option value="">Select Department</option>
                                                <option value="production">Production</option>
                                                <option value="maintenance">Maintenance</option>
                                                <option value="warehouse">Warehouse</option>
                                                <option value="quality">Quality Control</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="shift" class="form-label">Shift</label>
                                            <select class="form-select" id="shift">
                                                <option value="">Select Shift</option>
                                                <option value="morning">Morning (6AM-2PM)</option>
                                                <option value="afternoon">Afternoon (2PM-10PM)</option>
                                                <option value="night">Night (10PM-6AM)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" placeholder="e.g., Building A, Floor 2">
                                </div>
                                
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drag & Drop Image Here</h5>
                                    <p class="text-muted">or click to select file</p>
                                    <input type="file" id="imageFile" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageFile').click()">
                                        Choose File
                                    </button>
                                </div>
                                
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search me-2"></i>
                                        Check Compliance
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Detection Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="results" class="text-center text-muted">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>Upload an image to see PPE compliance results</p>
                            </div>
                            
                            <div id="loading" class="loading text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing image...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="mb-5">
            <h2 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>
                Compliance Dashboard
            </h2>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h3 id="totalChecks">-</h3>
                            <p class="mb-0">Total Checks</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h3 id="complianceRate">-</h3>
                            <p class="mb-0">Compliance Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h3 id="todayChecks">-</h3>
                            <p class="mb-0">Today's Checks</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h3 id="todayRate">-</h3>
                            <p class="mb-0">Today's Rate</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Department Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div id="departmentStats">
                                <p class="text-muted text-center">Loading department statistics...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Recent Violations</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentViolations">
                                <p class="text-muted text-center">Loading recent violations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history" class="mb-5">
            <h2 class="mb-4">
                <i class="fas fa-history me-2"></i>
                Compliance History
            </h2>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Recent Compliance Records</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadComplianceHistory()">
                        <i class="fas fa-refresh me-1"></i>
                        Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="complianceHistory">
                        <p class="text-muted text-center">Loading compliance history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const imageFile = document.getElementById('imageFile');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                imageFile.files = files;
                updateUploadArea(files[0]);
            }
        });
        
        imageFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                updateUploadArea(e.target.files[0]);
            }
        });
        
        function updateUploadArea(file) {
            const fileName = file.name;
            uploadArea.innerHTML = `
                <i class="fas fa-file-image fa-3x text-success mb-3"></i>
                <h5>${fileName}</h5>
                <p class="text-muted">Ready to upload</p>
                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageFile').click()">
                    Change File
                </button>
            `;
        }
        
        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('worker_id', document.getElementById('workerId').value);
            formData.append('worker_name', document.getElementById('workerName').value);
            formData.append('department', document.getElementById('department').value);
            formData.append('shift', document.getElementById('shift').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('file', imageFile.files[0]);
            
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/compliance/check-upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loading').classList.remove('show');
                document.getElementById('results').style.display = 'block';
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    displayError(result.message);
                }
                
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('results').style.display = 'block';
                displayError('Error uploading image: ' + error.message);
            }
        });
        
        function displayResults(data) {
            const isCompliant = data.is_compliant;
            const complianceScore = data.compliance_score;
            
            const cardClass = isCompliant ? 'compliance-card' : 'non-compliance-card';
            const statusIcon = isCompliant ? 'fa-check-circle text-success' : 'fa-times-circle text-danger';
            const statusText = isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
            
            document.getElementById('results').innerHTML = `
                <div class="card ${cardClass}">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas ${statusIcon} fa-3x"></i>
                            <h4 class="mt-2">${statusText}</h4>
                            <h5>Compliance Score: ${complianceScore.toFixed(1)}%</h5>
                        </div>
                        
                        <div class="ppe-detection">
                            <h6>PPE Detection Results:</h6>
                            <div class="ppe-item ${data.helmet_detected ? 'compliant' : 'non-compliant'}">
                                <i class="fas ${data.helmet_detected ? 'fa-check' : 'fa-times'}"></i>
                                <span>Helmet: ${data.helmet_detected ? 'Detected' : 'Missing'} ${data.helmet_detected ? `(${(data.helmet_confidence * 100).toFixed(1)}%)` : ''}</span>
                            </div>
                            <div class="ppe-item ${data.mask_detected ? 'compliant' : 'non-compliant'}">
                                <i class="fas ${data.mask_detected ? 'fa-check' : 'fa-times'}"></i>
                                <span>Mask: ${data.mask_detected ? 'Detected' : 'Missing'} ${data.mask_detected ? `(${(data.mask_confidence * 100).toFixed(1)}%)` : ''}</span>
                            </div>
                            <div class="ppe-item ${data.gloves_detected ? 'compliant' : 'non-compliant'}">
                                <i class="fas ${data.gloves_detected ? 'fa-check' : 'fa-times'}"></i>
                                <span>Gloves: ${data.gloves_detected ? 'Detected' : 'Missing'} ${data.gloves_detected ? `(${(data.gloves_confidence * 100).toFixed(1)}%)` : ''}</span>
                            </div>
                            <div class="ppe-item ${data.jacket_detected ? 'compliant' : 'non-compliant'}">
                                <i class="fas ${data.jacket_detected ? 'fa-check' : 'fa-times'}"></i>
                                <span>Jacket: ${data.jacket_detected ? 'Detected' : 'Missing'} ${data.jacket_detected ? `(${(data.jacket_confidence * 100).toFixed(1)}%)` : ''}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayError(message) {
            document.getElementById('results').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        // Dashboard functions
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
                const stats = await response.json();
                
                document.getElementById('totalChecks').textContent = stats.total_checks;
                document.getElementById('complianceRate').textContent = stats.compliance_rate.toFixed(1) + '%';
                document.getElementById('todayChecks').textContent = stats.today_checks;
                document.getElementById('todayRate').textContent = stats.today_compliance_rate.toFixed(1) + '%';
                
                // Department stats
                const deptStatsHtml = Object.entries(stats.department_stats).map(([dept, data]) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${dept}</span>
                        <div>
                            <span class="badge bg-primary">${data.total}</span>
                            <span class="badge bg-success">${data.rate.toFixed(1)}%</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('departmentStats').innerHTML = deptStatsHtml || '<p class="text-muted">No department data available</p>';
                
                // Recent violations
                const violationsHtml = stats.recent_violations.map(violation => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${violation.worker_name}</strong><br>
                            <small class="text-muted">${violation.department} - ${new Date(violation.timestamp).toLocaleString()}</small>
                        </div>
                        <span class="badge bg-danger">${violation.compliance_score.toFixed(1)}%</span>
                    </div>
                `).join('');
                
                document.getElementById('recentViolations').innerHTML = violationsHtml || '<p class="text-muted">No recent violations</p>';
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        async function loadComplianceHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/compliance/records?limit=20`);
                const records = await response.json();
                
                const historyHtml = records.map(record => `
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                        <div>
                            <h6 class="mb-1">${record.worker_name} (${record.worker_id})</h6>
                            <small class="text-muted">
                                ${record.department} - ${record.location || 'Unknown Location'} - 
                                ${new Date(record.timestamp).toLocaleString()}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge ${record.is_compliant ? 'bg-success' : 'bg-danger'} mb-1">
                                ${record.is_compliant ? 'Compliant' : 'Non-Compliant'}
                            </span>
                            <br>
                            <small>${record.compliance_score.toFixed(1)}%</small>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('complianceHistory').innerHTML = historyHtml || '<p class="text-muted">No compliance records found</p>';
                
            } catch (error) {
                console.error('Error loading compliance history:', error);
                document.getElementById('complianceHistory').innerHTML = '<p class="text-danger">Error loading compliance history</p>';
            }
        }
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats();
            loadComplianceHistory();
            
            // Refresh dashboard every 30 seconds
            setInterval(loadDashboardStats, 30000);
        });
    </script>
</body>
</html>
